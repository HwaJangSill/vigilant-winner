<!DOCTYPE html>
<html>
<head>
    <title>ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="/static/header.css">
    <link rel="stylesheet" href="/static/board.css">
    <link rel="stylesheet" href="/static/footer.css">
</head>
<body>
    {% include "header.html" %}
    <h1>ê²Œì‹œíŒ</h1>
    <main>
        <div id="searchBar">
            <form>
                <a href="/writing/" id="goToWrite">ê¸€ ì“°ëŸ¬ ê°€ê¸° &#10140;</a>
                <select name="searchType">
                    <option value="ALL">ì „ì²´</option>
                    <option value="TITLE">ì œëª©</option>
                    <option value="TEXT">ë‚´ìš©</option>
                    <option value="PLAN">í”Œëœ</option>
                    <option value="AUTH">ì‘ì„±ì</option>
                </select>
                <input type="text" name="search" placeholder="ê²€ìƒ‰" />
                <input type="submit" value="ğŸ”ï¸" id="searchBtn" />
            </form>
        </div>
        <table>
            <colgroup>
                <col>
                <col style="width: 10%;">
                <col style="width: 10%;">
                <col style="width: 20%;">
            </colgroup>
            <thead>
                <tr>
                    <th>ì œëª©</th>
                    <th>ì‘ì„±ì</th>
                    <th>í”Œëœ</th>
                    <th>ì‘ì„± ì‹œê°</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </main>
    <div id="pageBtn"></div>
    {% include "footer.html" %}
    <script>
        
        let postData;
        const searchForm = document.querySelector("form");
        const pageBtn = document.querySelector("#pageBtn");
        const tbody = document.querySelector("tbody");
        const select = document.querySelector("select");
        const searchInput = document.querySelector("input");
        
        // ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìœ„í•œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        searchForm.addEventListener("submit", (event) => {
            event.preventDefault();
            let searchType = select.value;
            let inputData = searchInput.value;
            search(searchType, inputData);
        });

        function createRow(idx){ // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ í…Œì´ë¸” ì•ˆì— í–‰ ì¶”ê°€
            tbody.innerHTML = "";
            let MAX = (idx*10 < postData.length) ? idx*10 : postData.length;
            for(let i=(idx-1)*10; i<MAX; i++){
                if (postData[i]['secret'] != 'False') {
                    tbody.innerHTML += `
                    <tr onclick="pwCheck(${postData[i]['post_id']})">
                        <td>${postData[i]['title']} ğŸ”’ï¸</td>
                        <td>${postData[i]['user_name']}</td>
                        <td>
                            <div id="${postData[i]['plan']}">${postData[i]['plan']}</div>
                        </td>
                        <td>${postData[i]['date']}</td>
                    </tr>`;
                } else {
                    tbody.innerHTML += `
                    <tr onclick="location.href='/view/?post_id=${postData[i]['post_id']}'">
                        <td>${postData[i]['title']}</td>
                        <td>${postData[i]['user_name']}</td>
                        <td>
                            <div id="${postData[i]['plan']}">${postData[i]['plan']}</div>
                        </td>
                        <td>${postData[i]['date']}</td>
                    </tr>`;
                }
            }
        }

        // ê²Œì‹œíŒì— ë‚˜ì—´ë  ìˆ˜ ìˆëŠ” ì´ ê²Œì‹œê¸€ì˜ ìˆ˜ëŠ” 10ê°œ
        // ê²Œì‹œê¸€ ê°œìˆ˜ì— ë¹„ë¡€í•˜ì—¬ ê²Œì‹œíŒ í•˜ë‹¨ì˜ ë²„íŠ¼ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        function createBtn(){
            pageBtn.innerHTML = "";
            const pageCount = postData.length/10;
            if(pageCount < 1) return
            for(let i=0; i<pageCount; i++){
                pageBtn.innerHTML += 
                `<button type="button" onclick="createRow(${i+1})">${i+1}</button>`;
            }
        }
        
        // ì‘ì„±ëœ ê²Œì‹œê¸€ì´ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜
        function emptyBody(){
            if(tbody.innerHTML == ''){
                tbody.innerHTML='<td colspan="4" style=\'text-align: center; font-size: 18px; font-weight: bold; color: gray;\'>ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤</td>';
            }
        }
        
        // ì„œë²„ì—ì„œ ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        function getData(inputData){
            fetch("/search/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    Query: inputData
                }),
            }).then((response) => response.json())
            .then((data) => {postData = data;})
            .then(() => createRow(1))
            .then(() => createBtn())
            .then(() => emptyBody());
        }
        

        // ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìœ„í•œ í•¨ìˆ˜(ì„œë²„ë¡œ ì…ë ¥í•œ ê°’ì„ í¬í•¨í•˜ëŠ” ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ìˆë„ë¡ ë©”íƒ€ ë¬¸ì '%' ë¥¼ ì‚¬ìš©í•¨)
        function search(searchType, inputData){
            QueryDict = {
                
                ALL: `SELECT * FROM board WHERE 
                    user_name like '%${inputData}%' OR 
                    plan like '%${inputData}%' OR 
                    title like '%${inputData}%' OR 
                    text like '%${inputData}%';`,
                
                TITLE: `SELECT * FROM board WHERE 
                    title like '%${inputData}%';`,

                TEXT: `SELECT * FROM board WHERE 
                    text like '%${inputData}%';`,
                
                PLAN: `SELECT * FROM board WHERE
                    plan like '%${inputData}%';`,

                AUTH: `SELECT * FROM board WHERE
                    user_name like '%${inputData}%';`

            }
            getData(QueryDict[searchType]);
        }

        // ë¹„ë°€ê¸€ë¡œ ì„¤ì •ëœ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
        function pwCheck(postid){
            let pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”");
            location.href=`/view/?post_id=${postid}&password=${pw}`;
        }
        
        // ê²Œì‹œíŒ ì´ˆê¸°í™”ë¥¼ ìœ„í•´ í˜ì´ì§€ê°€ ìƒˆë¡œ ëœë”ë§ ë  ë•Œë§ˆë‹¤ ì„œë²„ì—ì„œ ê²Œì‹œê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ëœë”ë§í•˜ê¸°
        getData("SELECT * FROM board;");

    </script>
</body>
</html>